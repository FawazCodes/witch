<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>Judy</title>

  <!-- Favicons -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#7c3aed">
  <meta name="theme-color" content="#0b0d12" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f6f7fb" media="(prefers-color-scheme: light)">

  <style>
    :root{
      --bg:#0b0d12; --fg:#e5e7eb; --muted:#94a3b8;
      --a:#7c3aed; --b:#10b981; --c:#f59e0b; --d:#06b6d4; --e:#e11d48; --f:#a3e635;
    }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f7fb; --fg:#0b0d12; --muted:#475569; } }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100% }
    body{
      background: radial-gradient(1200px 800px at 70% -10%, rgba(124,58,237,.16), transparent 60%),
                  radial-gradient(1000px 600px at 10% 110%, rgba(16,185,129,.13), transparent 60%),
                  var(--bg);
      color:var(--fg);
      font:16px/1.5 ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple Color Emoji, Segoe UI Emoji, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      touch-action:manipulation; user-select:none;
    }
    .wrap{ height:100%; display:grid; place-items:center; padding:24px }
    .start{
      position:relative; display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      padding:18px 28px; font-weight:900; font-size:20px; border-radius:999px; cursor:pointer;
      background:linear-gradient(135deg,var(--a),var(--b)); color:#fff; border:0; box-shadow:0 10px 30px rgba(0,0,0,.25);
      -webkit-tap-highlight-color:transparent;
    }
    .start:active{ transform:translateY(1px) }

    .play{ position:fixed; inset:0; display:none; overflow:hidden; contain:content; backface-visibility:hidden }
    .hud{ position:absolute; inset-inline:10px; top:10px; display:flex; justify-content:flex-end; gap:8px; pointer-events:none }
    .chip{ pointer-events:auto; background:rgba(0,0,0,.35); color:#fff; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); font-weight:800; font-size:12px }
    .toast{ position:absolute; left:50%; bottom:18px; transform:translateX(-50%); background:rgba(0,0,0,.55); padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); font-weight:700; font-size:13px; opacity:0; transition:opacity .2s ease }
    .toast.show{ opacity:1 }

    .piece{ position:absolute; will-change:transform,opacity; font-weight:900; text-shadow:0 1px 0 rgba(0,0,0,.08), 0 0 4px rgba(255,255,255,.08); transform:translate(-50%, -50%); transition: transform .2s ease; contain:content }
    .piece.img{ text-shadow:none; filter: drop-shadow(0 4px 10px rgba(0,0,0,.25)); pointer-events:none; user-select:none }
    .magnify{ transform:translate(-50%,-50%) scale(1.25) !important }
    .glitter{ animation:glitter .5s linear 4 }
    @keyframes glitter{ from{ filter: drop-shadow(0 0 6px rgba(250,204,21,.55)) } to{ filter: drop-shadow(0 0 2px rgba(250,204,21,.2)) } }

    .fall{ animation:fall linear forwards }
    @keyframes fall{ 0%{ transform:translate(calc(-50% + var(--sx,0)),calc(-50% + var(--sy,0))) rotate(var(--rt,0deg)) scale(var(--sc,1)); opacity:1 } 100%{ transform:translate(calc(-50% + var(--ex,0)),calc(-50% + var(--ey,240px))) rotate(calc(var(--rt,0deg) + 180deg)) scale(var(--sc,1)); opacity:0 } }
    .pop{ animation:pop .3s cubic-bezier(.2,.9,.2,1) forwards }
    @keyframes pop{ 0%{ transform:translate(-50%,-50%) scale(.2); opacity:0 } 60%{ opacity:1 } 100%{ transform:translate(-50%,-50%) scale(1); opacity:1 } }
    .fade{ animation:fade .6s ease forwards }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }

    .shake{ animation:shake .28s linear 1 }
    @keyframes shake{ 0%,100%{ transform:translate(0,0) } 25%{ transform:translate(2px,-2px) } 50%{ transform:translate(-2px,2px) } 75%{ transform:translate(2px,2px) } }

    .flash{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,.15), transparent); opacity:0; pointer-events:none; transition:opacity .2s ease }
    .flash.show{ opacity:1 }

    @media (prefers-reduced-motion: reduce){
      .fall{ animation:appear .2s ease-out forwards }
      @keyframes appear{ from{ opacity:0 } to{ opacity:1 } }
      .shake{ animation:none }
    }

    .smirk{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.2); font-size:110px; filter:drop-shadow(0 6px 18px rgba(0,0,0,.3)); opacity:0 }
    .smirk.show{ animation:smirkIn .6s cubic-bezier(.2,.9,.2,1) forwards }
    @keyframes smirkIn{ to{ transform:translate(-50%,-50%) scale(1); opacity:1 } }

    .bob{ animation:bob .8s ease-in-out 6 }
    @keyframes bob{ 0%,100%{ transform:translate(-50%,-50%) translateY(0) } 50%{ transform:translate(-50%,-50%) translateY(-5px) } }

    .bump{ animation:bump .1s ease-out 1 }
    @keyframes bump{ from{ transform:scale(.985) } to{ transform:scale(1) } }

    .speaker{ width:32px; height:32px; border-radius:999px; display:grid; place-items:center; }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <button class="start" id="startBtn" aria-label="Start">ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß</button>
  </div>

  <main class="play" id="play" aria-label="Play field" tabindex="0">
    <div class="hud">
      <button class="chip speaker" id="muteBtn" aria-pressed="false" title="Sound">üîä</button>
    </div>
    <div class="smirk" id="smirk" aria-hidden="true">üòè</div>
    <div class="toast" id="toast" aria-live="polite">ÿ∂ÿ∫ÿ∑ ŸÖÿ∑ŸàŸÑ ŸÑŸÑŸÅŸàÿ∂Ÿâ</div>
    <div class="flash" id="flash"></div>
  </main>

  <audio id="sfxLisah" src="falafel.mp3" preload="auto" playsinline></audio>
  <audio id="sfxKeko" src="keko.mp3" preload="auto" playsinline></audio>

<script>
(()=>{
  const wrap = document.getElementById('wrap');
  const startBtn = document.getElementById('startBtn');
  const play = document.getElementById('play');
  const smirk = document.getElementById('smirk');
  const toast = document.getElementById('toast');
  const muteBtn = document.getElementById('muteBtn');
  const flash = document.getElementById('flash');
  const sfxLisah = document.getElementById('sfxLisah');
  const sfxKeko = document.getElementById('sfxKeko');
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  let pressTimer = null; let pressing = false; let muted = false; // sound on by default
  let frozenUntil = 0; let lastTrail = 0; let pieceAdds = 0;
  let preloadedImg = false; let lowMode = false;

  // quality profile
  const mem = navigator.deviceMemory || 4;
  const quality = { density: mem <= 3 ? 0.6 : 0.85, heavy: mem > 3, lifespan: mem <= 3 ? 1100 : 1300 };

  // FPS sampler to auto degrade
  function startFPSWatch(){ let last = performance.now(); let samples = []; function loop(){ const now = performance.now(); const fps = 1000/(now - last); last = now; samples.push(fps); if(samples.length > 30) samples.shift(); const avg = samples.reduce((a,b)=>a+b,0)/samples.length; if(!lowMode && avg < 40){ lowMode = true; quality.density *= 0.7; quality.heavy = false; } requestAnimationFrame(loop); } requestAnimationFrame(loop); }

  // tiny WebAudio ping for keko tail
  let actx = null; function ensureActx(){ if(!actx){ try{ actx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
  function ping(){ if(!actx) return; const o=actx.createOscillator(); const g=actx.createGain(); o.type='triangle'; o.frequency.value=1600; g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.18, actx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.12); o.connect(g).connect(actx.destination); o.start(); o.stop(actx.currentTime+0.15); }

  // utilities
  function showToast(msg, t=900){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(showToast.tid); showToast.tid = setTimeout(()=>toast.classList.remove('show'), t); }
  function rand(min,max){ return Math.random()*(max-min)+min }
  function pickColor(){ const p=['#7c3aed','#10b981','#f59e0b','#06b6d4','#e11d48','#a3e635']; return p[(Math.random()*p.length)|0] }

  // soft limiter
  const MAX_PIECES = 220;
  function enforceCap(){ const nodes = play.querySelectorAll('.piece'); if(nodes.length > MAX_PIECES){ const kill = nodes.length - MAX_PIECES; for(let i=0;i<kill;i++){ nodes[i].remove(); } } }
  function appendPiece(el){ play.appendChild(el); if((pieceAdds = (pieceAdds+1)|0) % 16 === 0) enforceCap(); }

  // micro spark
  function spark(x,y){ const s = document.createElement('div'); s.style.position='absolute'; s.style.left=x+'px'; s.style.top=y+'px'; s.style.width='8px'; s.style.height='8px'; s.style.borderRadius='50%'; s.style.background='rgba(255,255,255,.8)'; s.style.transform='translate(-50%,-50%)'; s.style.opacity='1'; s.style.transition='opacity .1s ease, transform .1s ease'; appendPiece(s); requestAnimationFrame(()=>{ s.style.opacity='0'; s.style.transform='translate(-50%,-50%) scale(1.5)'; }); setTimeout(()=>s.remove(), 120); }

  // haptic sim
  function haptic(){ play.classList.add('bump'); setTimeout(()=>play.classList.remove('bump'), 100); }

  // token chooser
  const LTXT = 'ŸÑÿ≥Ÿá';
  function chooseToken(){ const roll = Math.random(); if(roll < 0.10) return { type:'keko', mode:'text', text:'ŸÉŸäŸÉŸà' }; if(roll < 0.38) return { type:'smirk', mode:'text', text:'üòè' }; if(Math.random() < 0.28) return { type:'lisah', mode:'img', src:'lisah.png' }; return { type:'lisah', mode:'text', text:LTXT }; }

  // audio per token
  function playForToken(token){ if(muted) return; try{ if(token.type==='keko'){ sfxKeko.currentTime = 0; sfxKeko.play(); } else if(token.type==='lisah'){ sfxLisah.currentTime = 0; sfxLisah.play(); } }catch(e){} }
  function playBoom(){ if(muted) return; try{ sfxLisah.currentTime = 0; sfxLisah.play(); }catch(e){} }
  function stutterFalafel(){ if(muted) return; try{ sfxLisah.pause(); sfxLisah.currentTime=0; sfxLisah.play(); setTimeout(()=>{ sfxLisah.pause(); sfxLisah.currentTime=.12; sfxLisah.play(); },110); }catch(e){} }
  sfxKeko.addEventListener('ended', ()=>{ ensureActx(); ping(); });

  // helpers
  function makePiece(token, x, y, size){ let el; if(token && token.mode === 'img'){ el = document.createElement('img'); el.src = token.src; el.alt = ''; el.loading = 'lazy'; el.decoding = 'async'; el.className = 'piece img'; el.style.width = (size || rand(36,64)) + 'px'; } else if(token){ el = document.createElement('span'); el.className = 'piece'; el.textContent = token.text; el.style.fontSize = (size || rand(18,36)) + 'px'; el.style.color = pickColor(); } else { el = document.createElement('div'); el.className = 'piece'; el.style.width='8px'; el.style.height='8px'; el.style.borderRadius='50%'; el.style.background='rgba(255,255,255,.85)'; } el.style.left = x + 'px'; el.style.top = y + 'px'; return el; }
  function spawnParrots(x,y, n){ const parrot = { type:'parrot', mode:'text', text:'ü¶ú' }; const count = Math.max(6, Math.round((n || 10) * quality.density)); for(let i=0;i<count;i++){ const el = makePiece(parrot, x + rand(-70,70), y + rand(-40,40), rand(22,32)); el.classList.add('pop'); appendPiece(el); setTimeout(()=>el.remove(), 900); } }
  function spawnYemenFlags(x,y){ const flag = { type:'flag', mode:'text', text:'üáæüá™' }; const count = Math.max(3, Math.round(6 * quality.density)); for(let i=0;i<count;i++){ const el = makePiece(flag, x + rand(-100,100), y + rand(-60,60), rand(20,28)); el.classList.add('pop'); appendPiece(el); setTimeout(()=>el.remove(), 900); } }

  // effects
  function rainBurst(x,y, token){ const base = 22 + (Math.random()*10|0); const total = Math.max(12, Math.round(base * quality.density)); for(let i=0;i<total;i++){ const el = makePiece(token, x, y); el.classList.add('fall'); const dx = rand(-160, 160); const dy = rand(120, 300); el.style.setProperty('--sx','0px'); el.style.setProperty('--sy','0px'); el.style.setProperty('--ex', dx + 'px'); el.style.setProperty('--ey', dy + 'px'); el.style.setProperty('--rt', rand(-120,120) + 'deg'); el.style.setProperty('--sc', rand(.9,1.15)); el.style.animationDuration = (prefersReduced ? 200 : rand(700,1200)) + 'ms'; appendPiece(el); setTimeout(()=>el.remove(), prefersReduced ? 260 : 1200); } }

  const bodies = []; let ticking = false;
  function bouncyFloor(x,y, token){ const base = 12 + (Math.random()*6|0); const total = Math.max(6, Math.round(base * quality.density)); for(let i=0;i<total;i++){ const el = makePiece(token, x, y, token && token.mode==='img' ? rand(34,56) : rand(18,30)); appendPiece(el); const body = { el, x, y, vx: rand(-2,2), vy: rand(-1.4,-3), life: 110 + (Math.random()*60|0) }; bodies.push(body); } tick(); }

  function spiralStorm(x,y, token){ const pts = Math.max(18, Math.round(30 * quality.density)); for(let i=0;i<pts;i++){ const ang = i * 0.35; const r = 4 + i*2.5; const el = makePiece(token, x + Math.cos(ang)*r, y + Math.sin(ang)*r, token && token.mode==='img'? 26: 20); el.classList.add('pop'); appendPiece(el); setTimeout(()=>el.remove(), 1100); } }

  function rippleText(x,y, token){ if(token && token.type==='lisah' && token.mode==='text'){ const letters = ['ŸÑ','ÿ≥','Ÿá']; letters.forEach((ch,i)=>{ setTimeout(()=>{ const ring = 6 + i*6; for(let k=0;k<ring;k++){ const ang = (k/ring)*Math.PI*2; const rx = Math.cos(ang)*(36+i*16); const ry = Math.sin(ang)*(36+i*16); const el = makePiece({type:'lisah', mode:'text', text:ch}, x+rx, y+ry, 18); el.className += ' fade'; appendPiece(el); setTimeout(()=>el.remove(), 800); } }, i*90); }); } else { const count = Math.max(10, Math.round(14 * quality.density)); for(let i=0;i<count;i++){ const ang = (i/count)*Math.PI*2; const rx = Math.cos(ang)*64; const ry = Math.sin(ang)*64; const el = makePiece(token, x+rx, y+ry, token && token.mode==='img'? 26: 20); el.className += ' fade'; appendPiece(el); setTimeout(()=>el.remove(), 800); } } }

  function glitchFlash(x,y, token){ if(!quality.heavy) return rainBurst(x,y, token); const el = makePiece(token, x, y, 58); appendPiece(el); let i = 0; const id = setInterval(()=>{ el.style.transform = `translate(-50%,-50%) translate(${rand(-6,6)}px,${rand(-3,3)}px)`; el.style.opacity = Math.random()>.3?1:.25; i++; if(i>8){ clearInterval(id); el.remove(); } }, prefersReduced? 40: 50); }

  // new effects
  function goldenLisah(x,y){ const gold = { type:'lisah', mode:'text', text:LTXT }; const el = makePiece(gold, x, y, 52); el.style.color = '#facc15'; el.classList.add('pop','glitter'); appendPiece(el); setTimeout(()=>{ rainBurst(x,y,{type:'lisah', mode:'text', text:LTXT}); el.remove(); }, 360); }
  function flagFireworks(x,y){ const ring = Math.max(8, Math.round(12 * quality.density)); for(let i=0;i<ring;i++){ const ang = (i/ring)*Math.PI*2; const rx = Math.cos(ang)*rand(36,80); const ry = Math.sin(ang)*rand(36,80); const el = makePiece({type:'flag', mode:'text', text:'üáæüá™'}, x+rx, y+ry, 18); el.className += ' fade'; appendPiece(el); setTimeout(()=>el.remove(), 800); } }
  function smirkLens(x,y){ if(!quality.heavy) return; const big = document.createElement('div'); big.className='smirk show'; big.textContent='üòè'; big.style.left=x+'px'; big.style.top=y+'px'; appendPiece(big); setTimeout(()=>big.remove(), 560); const nodes = [...play.querySelectorAll('.piece')].slice(-30); nodes.forEach(n=>{ const nx=parseFloat(n.style.left)||0; const ny=parseFloat(n.style.top)||0; const d=Math.hypot(nx-x, ny-y); if(d<110) n.classList.add('magnify'); setTimeout(()=>n.classList.remove('magnify'), 520); }); }
  function ripplePortal(x,y){ if(!quality.heavy) return; const nodes = [...play.querySelectorAll('.piece')].slice(-30); nodes.forEach((n,i)=>{ n.style.transition = prefersReduced ? 'opacity .2s' : 'transform .3s cubic-bezier(.2,.9,.2,1), opacity .3s'; n.style.transform = `translate(-50%,-50%) translate(${x}px, ${y}px)`; n.style.opacity = .7; setTimeout(()=>{ n.style.opacity=1; }, 300 + i*2); }); setTimeout(()=>{ rippleText(x,y,{type:'lisah', mode:'text', text:LTXT}); }, 340); }

  function parrotSpiral(x,y){ const pts=Math.max(10, Math.round(14 * quality.density)); for(let i=0;i<pts;i++){ const ang=i*(Math.PI*2/pts); const r=6+i*5; const el=makePiece({type:'parrot', mode:'text', text:'ü¶ú'}, x+Math.cos(ang)*r, y+Math.sin(ang)*r, 20); el.classList.add('pop'); appendPiece(el); setTimeout(()=>el.remove(), 900); } }
  function parrotPerch(x,y){ const el=makePiece({type:'parrot', mode:'text', text:'ü¶ú'}, x, y-18, 26); el.classList.add('bob'); appendPiece(el); setTimeout(()=>el.remove(), 900); }

  function meteor(){ const rect=play.getBoundingClientRect(); const startX=rand(-40, rect.width*0.2); const startY=rand(-20, rect.height*0.2); const steps = 24; flash.classList.add('show'); setTimeout(()=>flash.classList.remove('show'), 150); for(let i=0;i<steps;i++){ setTimeout(()=>{ const t=i/steps; const x=startX + t*(rect.width+100); const y=startY + t*(rect.height+70); const tk = (i%2)? {type:'smirk', mode:'text', text:'üòè'} : {type:'lisah', mode:'text', text:LTXT}; const el=makePiece(tk,x,y,18+i%4); appendPiece(el); setTimeout(()=>el.remove(), 800); }, i*16); } }

  function freezeFrame(){ frozenUntil = Date.now()+260; const nodes=play.querySelectorAll('.piece'); nodes.forEach(n=>{ n.style.animationPlayState='paused'; }); setTimeout(()=>{ nodes.forEach(n=> n.style.animationPlayState=''); frozenUntil=0; }, 260); }

  function nameRoulette(x,y){ const holder=makePiece({type:'lisah', mode:'text', text:'?'}, x,y, 48); appendPiece(holder); const opts=['üòè','ŸÉŸäŸÉŸà',LTXT]; let i=0; const id=setInterval(()=>{ holder.textContent=opts[i%opts.length]; i++; }, 60); setTimeout(()=>{ clearInterval(id); const final = Math.random()<0.8? {type:'lisah', mode:'text', text:LTXT} : {type:'keko', mode:'text', text:'ŸÉŸäŸÉŸà'}; holder.remove(); playForToken(final); rainBurst(x,y, final); if(final.type==='lisah' && Math.random()<0.35) spawnYemenFlags(x,y); if(final.type==='keko'){ spawnParrots(x,y); parrotSpiral(x,y); parrotPerch(x,y); } }, 320); }

  // generic spectacle
  function smirkBurst(x,y){ const token = { type:'smirk', mode:'text', text:'üòè' }; rainBurst(x,y, token); }
  function tornado(x,y){ if(!quality.heavy) return; const nodes = [...play.querySelectorAll('.piece')].slice(-60); if(nodes.length===0) return; nodes.forEach((el,idx)=>{ el.style.transition = prefersReduced ? 'opacity .2s' : 'transform .35s cubic-bezier(.2,.9,.2,1), opacity .35s'; el.style.transform = `translate(-50%,-50%) translate(${x}px, ${y}px)`; el.style.opacity = .6; setTimeout(()=>{ el.style.transition = 'transform .35s ease, opacity .35s ease'; el.style.transform = `translate(-50%,-50%) translate(${x + rand(-30,30)}px, ${y + rand(-30,30)}px)`; el.style.opacity = 1; }, 360 + idx*2); }); if(!prefersReduced){ play.classList.add('shake'); setTimeout(()=>play.classList.remove('shake'), 280); } else { flash.classList.add('show'); setTimeout(()=>flash.classList.remove('show'), 200); } }
  function confettiColumns(){ const rect = play.getBoundingClientRect(); const cols = 4; const gap = rect.width/(cols+1); for(let c=1;c<=cols;c++){ const x = gap*c; const tk = {type:'lisah', mode:'text', text:LTXT}; rainBurst(x, 20, tk); if(Math.random()<0.3) spawnYemenFlags(x, 80); } }
  function emojiGeyser(){ const rect = play.getBoundingClientRect(); const x = rect.width/2, y = rect.height-30; bouncyFloor(x, y, {type:'smirk', mode:'text', text:'üòè'}); }
  function curtainDrop(){ const rect = play.getBoundingClientRect(); const rows = 3; const cols = 6; const w = rect.width/(cols+1); const h = rect.height/(rows+1); for(let r=1;r<=rows;r++){ for(let c=1;c<=cols;c++){ const tk = Math.random()<0.2 ? {type:'lisah', mode:'img', src:'lisah.png'} : {type:'lisah', mode:'text', text:LTXT}; const el = makePiece(tk, w*c, -20, 26); el.classList.add('fall'); el.style.setProperty('--ex', rand(-16,16)+'px'); el.style.setProperty('--ey', (h*r + rand(16,40))+'px'); el.style.setProperty('--rt', rand(-24,24)+'deg'); el.style.animationDuration = (prefersReduced? 160 : rand(600,1000))+'ms'; appendPiece(el); setTimeout(()=>el.remove(), 1300); if(tk.type==='lisah' && Math.random()<0.18) spawnYemenFlags(w*c, h*r); } } }
  function comet(){ if(!quality.heavy) return; const rect = play.getBoundingClientRect(); const x0 = rand(0, rect.width*0.3); const y0 = rand(rect.height*0.1, rect.height*0.4); const dx = rect.width + 100; const dy = rect.height + 60; const steps = 24; for(let i=0;i<steps;i++){ setTimeout(()=>{ const t = i/steps; const x = x0 + t*dx; const y = y0 + t*dy; const tk = (i%3)? {type:'smirk', mode:'text', text:'üòè'} : {type:'lisah', mode:'text', text:LTXT}; const el = makePiece(tk, x, y, 16 + i%4); el.style.opacity = .9; appendPiece(el); setTimeout(()=>el.remove(), 800); if(tk.type==='lisah' && Math.random()<0.12) spawnYemenFlags(x, y); }, i*18); } }

  // effect pools
  const glyphEffects = [rainBurst, bouncyFloor, spiralStorm, rippleText, glitchFlash];
  const genericEffects = [smirkBurst, comet, tornado];

  function randomEffect(x,y){
    // rare specials
    if(Math.random() < 0.005){ meteor(); return; }
    if(Math.random() < 0.003){ freezeFrame(); }
    if(Math.random() < 0.05){ nameRoulette(x,y); return; }

    const token = chooseToken();
    // golden variant for lisah
    if(token.type==='lisah' && token.mode==='text' && Math.random()<0.06){ goldenLisah(x,y); if(Math.random()<0.35) flagFireworks(x,y); playForToken(token); return; }

    // choose effect
    const pool = token.type==='smirk' ? [smirkBurst].concat(quality.heavy ? [comet, tornado] : []) : glyphEffects;
    const fx = pool[(Math.random()*pool.length)|0];
    fx(x,y, token);

    // audio
    playForToken(token);

    // pairings
    if(token.type==='keko'){ spawnParrots(x,y); parrotSpiral(x,y); parrotPerch(x,y); }
    if(token.type==='lisah' && Math.random()<0.3){ spawnYemenFlags(x,y); }

    // occasional extras
    if(quality.heavy && Math.random()<0.1) smirkLens(x,y);
    if(quality.heavy && Math.random()<0.08) ripplePortal(x,y);
  }

  // physics tick for bouncy pieces with freeze support
  function tick(){ if(ticking) return; ticking = true; const rect = play.getBoundingClientRect(); const g = prefersReduced? 0.001 : 0.10; const bounce = 0.6; const fric = 0.996; function step(){ if(frozenUntil && Date.now() < frozenUntil){ requestAnimationFrame(step); return; } for(let i=bodies.length-1;i>=0;i--){ const b = bodies[i]; b.vy += g; b.x += b.vx*6; b.y += b.vy*6; b.vx *= fric; b.vy *= fric; b.life--; if(b.y > rect.height-20){ b.y = rect.height-20; b.vy *= -bounce; b.vx *= 0.96; } if(b.x < 20 || b.x > rect.width-20){ b.vx *= -bounce; } b.el.style.left = b.x + 'px'; b.el.style.top = b.y + 'px'; if(b.life <= 0){ b.el.style.opacity = 0; b.el.remove(); bodies.splice(i,1); } } if(bodies.length){ requestAnimationFrame(step); } else { ticking = false; } } requestAnimationFrame(step); }

  function chaos(x,y){ playForToken({type:'lisah'}); stutterFalafel(); const rect = play.getBoundingClientRect(); let t = 0; const maxBursts = quality.heavy ? 8 : 6; const spam = setInterval(()=>{ const rx = rand(40, rect.width-40); const ry = rand(40, rect.height-40); randomEffect(rx, ry); t++; if(t>=maxBursts){ clearInterval(spam); } }, 160); if(!prefersReduced){ play.classList.add('shake'); setTimeout(()=>play.classList.remove('shake'), 260); } else { flash.classList.add('show'); setTimeout(()=>flash.classList.remove('show'), 180); } haptic(); }

  function startShow(){ wrap.style.display = 'none'; play.style.display = 'block'; ensureActx(); if(!preloadedImg){ const img = new Image(); img.src = 'lisah.png'; preloadedImg = true; } startFPSWatch(); playBoom(); smirk.classList.add('show'); setTimeout(()=> smirk.classList.remove('show'), 700); const r = play.getBoundingClientRect(); const cx = r.width/2, cy = r.height/2; curtainDrop(); setTimeout(()=>randomEffect(cx, cy), 140); setTimeout(()=>emojiGeyser(), 300); setTimeout(()=>confettiColumns(), 520); showToast('ÿ∂ÿ∫ÿ∑ ŸÖÿ∑ŸàŸÑ ŸÑŸÑŸÅŸàÿ∂Ÿâ'); }

  // pause when hidden
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ sfxLisah.pause(); sfxKeko.pause(); } });

  // interactions
  startBtn.addEventListener('click', startShow, { passive:true });

  play.addEventListener('pointerdown', e=>{ pressing = true; const r = play.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top; spark(x,y); pressTimer = setTimeout(()=>{ chaos(x,y); }, 500); }, { passive:true });
  play.addEventListener('pointermove', e=>{ if(!pressing) return; const now=Date.now(); if(now - lastTrail < 50) return; lastTrail = now; const r = play.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top; const ch = ['ŸÑ','ÿ≥','Ÿá'][(Math.random()*3)|0]; const el = makePiece({type:'trail', mode:'text', text:ch}, x, y, 14); el.classList.add('pop'); appendPiece(el); setTimeout(()=>el.remove(), 700); }, { passive:true });
  play.addEventListener('pointerup', ()=>{ pressing = false; clearTimeout(pressTimer); pressTimer = null; }, { passive:true });
  play.addEventListener('pointercancel', ()=>{ pressing = false; clearTimeout(pressTimer); pressTimer = null; }, { passive:true });

  play.addEventListener('pointerdown', e=>{ const r = play.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top; randomEffect(x,y); }, { passive:true });

  play.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ const r=play.getBoundingClientRect(); randomEffect(r.width/2,r.height/2); e.preventDefault(); } });

  // mute toggle
  muteBtn.addEventListener('click', ()=>{ const nowMuted = muteBtn.getAttribute('aria-pressed') === 'true' ? false : true; muteBtn.setAttribute('aria-pressed', String(nowMuted)); muted = nowMuted; muteBtn.textContent = muted ? 'üîá' : 'üîä'; if(!muted) playBoom(); });
})();
</script>
</body>
</html>
